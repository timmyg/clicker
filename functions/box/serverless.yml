service: box
frameworkVersion: '>=2.0.0 <3.0.0'
provider:
  name: aws
  memorySize: 1024
  versionFunctions: false
  runtime: nodejs12.x
  # tracing: true
  logRetentionInDays: 14
  deploymentBucket:
    name: serverless-deploys-clicker
  environment:
    stage: ${self:custom.stage}
    region: ${opt:region, self:provider.region}
    tableBox: ${self:custom.tableBox}
    graphqlApiUrl: ${env:GRAPHQL_API_URL, self:custom.graphqlApiUrl}
    graphqlApiKey: ${env:GRAPHQL_API_KEY, self:custom.graphqlApiKey}
  iamRoleStatements: ${file(../serverless.common.yml):iamRoleStatements}
resources:
  Resources:
    BoxesTable: ${file(./table.boxes.yml)}
plugins:
  - serverless-prune-plugin
  - serverless-deployment-bucket
  - serverless-domain-manager
  - serverless-sentry
  - serverless-dotenv-plugin
  - serverless-plugin-tracing
  - serverless-bundle
  - serverless-appsync-plugin
custom:
  stage: ${opt:stage}
  tableBox: boxes-${self:custom.stage}
  graphqlApiUrl: { Fn::GetAtt: [GraphQlApi, GraphQLUrl] }
  graphqlApiKey: { Fn::GetAtt: [GraphQlApiKeyDefault, ApiKey] }
  bundle:
    sourcemaps: false
  prune:
    automatic: true
    number: 3
  domains: ${file(../serverless.common.yml):domains}
  customDomain:
    domainName: ${self:custom.domains.${self:custom.stage}}
    basePath: boxes
    certificateName: 'api.tryclicker.com'
    stage: ${self:custom.stage}
    createRoute53Record: true
    endpointType: 'edge'
  sentry:
    dsn: ${env:SENTRY_DSN_ENDPOINT}
  dotenv:
    basePath: ../
  appSync:
    name: ${self:service}-${self:custom.stage}
    authenticationType: API_KEY
    apiKeys:
      - myApiKey
    schema: 'schema.graphql'
    dataSources:
      - type: AMAZON_DYNAMODB
        name: Boxes
        config:
          tableName: ${self:custom.tableBox}
      - type: AWS_LAMBDA
        name: fetchBoxProgramFunction
        description: 'attach current program'
        config:
          functionName: fetchBoxProgram
      - type: AWS_LAMBDA
        name: fetchBoxProgramGameFunction
        description: 'attach program game'
        config:
          functionName: fetchBoxProgramGame
    # defaultMappingTemplates: # default templates. Useful for Lambda templates that are often repetitive. Will be used if the template is not specified in a resolver
    #   request: request-get-source.vtl
    #   response: response-get.vtl
    mappingTemplates:
      - dataSource: Boxes
        type: Mutation
        field: addBox
        request: request-create.vtl
        response: response-create.vtl
      - dataSource: Boxes
        type: Mutation
        field: updateBoxChannel
        request: request-update-channel.vtl
        response: response-update-channel.vtl
      - dataSource: Boxes
        type: Query
        field: box
        request: request-get.vtl
        response: response-get.vtl
      - dataSource: Boxes
        type: Query
        field: boxes
        request: request-get-all.vtl
        response: response-get-all.vtl
      - dataSource: fetchBoxProgramFunction
        type: BoxLive
        field: program
        request: request-get-source.vtl
        response: response-get.vtl
      - dataSource: fetchBoxProgramGameFunction
        type: Program
        field: game
        request: request-get-source.vtl
        response: response-get.vtl
functions:
  fetchBoxProgram:
    handler: box.fetchBoxProgram
  fetchBoxProgramGame:
    handler: box.fetchBoxProgramGame
  health:
    handler: box.health
    events:
      - http:
          path: health
          method: get
  createDirectv:
    handler: box.createDirectv
    events:
      - http:
          path: '{locationId}/directv'
          method: post
  create:
    handler: box.create
    events:
      - http:
          path: '{locationId}'
          method: post
  updateChannel:
    handler: box.updateChannel
    events:
      - http:
          path: '{locationId}'
          method: put
  get:
    handler: box.get
    events:
      - http:
          path: '{locationId}/{boxId}'
          method: get
  getAll:
    handler: box.getAll
    events:
      - http:
          path: '{locationId}'
          method: get
